# ä½¿ç”¨å˜åŽ‹å™¨å®žçŽ°ç®€å•çš„å¯¹è±¡æ£€æµ‹:PyTorch ä¸­ Pix2Seq æ¨¡åž‹çš„ç®€å•å®žçŽ°

> åŽŸæ–‡ï¼š<https://pub.towardsai.net/easy-object-detection-with-transformers-simple-implementation-of-pix2seq-model-in-pytorch-fde3e7162ce7?source=collection_archive---------1----------------------->

![](img/dd9894dbdc0a4a4b5739b6de8ae69862.png)

æˆ‘å¯¹ä½œè€…çš„ Pix2Seq | Image çš„ç®€å•å®žçŽ°

# ä»‹ç»

ç›®æ ‡æ£€æµ‹ä¸ä¸€å®šæ˜¯ä¸€é¡¹å›°éš¾çš„ä»»åŠ¡ï¼æˆ‘æ¸…æ¥šåœ°è®°å¾—æˆ‘ç¬¬ä¸€æ¬¡ä»Žé›¶å¼€å§‹å®žçŽ° YOLO çš„æ—¶å€™ï¼Œç†è§£å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„æ˜¯ä¸€ä»¶ç—›è‹¦çš„äº‹æƒ…ã€‚å¯¹äºŽè®¡ç®—æœºè§†è§‰åº”ç”¨çš„åˆå­¦è€…æ¥è¯´ï¼Œæˆ‘ç›¸ä¿¡**ç‰©ä½“æ£€æµ‹æ˜¯åˆ†ç±»ã€åˆ†å‰²ç­‰ä¸­æœ€éš¾ç†è§£çš„**ã€‚

å½“æˆ‘ç¬¬ä¸€æ¬¡å¬è¯´æ¥è‡ª **ICLR 2022** çš„è®ºæ–‡â€œ [Pix2seq:ç”¨äºŽå¯¹è±¡æ£€æµ‹çš„è¯­è¨€å»ºæ¨¡æ¡†æž¶](https://arxiv.org/abs/2109.10852)â€æ—¶ï¼Œæˆ‘å˜å¾—ç›¸å½“å…´å¥‹ï¼Œæˆ‘ç¡®ä¿¡æˆ‘çš„ä¸‹ä¸€ç¯‡åšå®¢æ–‡ç« å°†ä¼šæ˜¯å…³äºŽå®ƒçš„ï¼›æ‰€ä»¥ï¼Œæˆ‘å†™äº†è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›ä½ ä¼šå–œæ¬¢ï¼Œå¹¶å‘çŽ° pix2seq æ¨¡åž‹å¾ˆå®¹æ˜“ç†è§£å’Œå®žçŽ°ã€‚

åœ¨æœ¬æ•™ç¨‹ç»“æŸæ—¶ï¼Œæ‚¨å°†å­¦ä¹ å®žçŽ°ä¸€ä¸ªç®€å•çš„å¯¹è±¡æ£€æµ‹æ¨¡åž‹ï¼Œå®ƒä¼šäº§ç”Ÿä»¥ä¸‹ç»“æžœ:

![](img/3f291bc0043b7c51e18e55bc0d409ea6.png)

æˆ‘ä»¬çš„æœ€ç»ˆæ¨¡åž‹åœ¨éªŒè¯é›†ä¸Šçš„é¢„æµ‹|ä½œè€…å›¾ç‰‡

æˆ‘æŠŠæˆ‘æ‰€æœ‰çš„ä»£ç éƒ½ä½œä¸º [**Google Colab ç¬”è®°æœ¬**](https://colab.research.google.com/drive/1UeYIZ6_GHNwCHSi8nNV5dVc3oUrM5-BA?usp=sharing) å’Œ [**Kaggle ç¬”è®°æœ¬**](https://www.kaggle.com/code/moeinshariatnia/object-detection-w-transformers-pix2seq-pytorch/notebook) æä¾›ã€‚æˆ‘è¿˜æŠŠæ•´ä¸ªé¡¹ç›®å’Œä»£ç  [**æ”¾åˆ°äº†æˆ‘çš„ GitHub**](https://github.com/moein-shariatnia/Pix2Seq) ä¸Šã€‚

## è¿™ç¯‡è®ºæ–‡çš„æœ‰è¶£ä¹‹å¤„åœ¨äºŽ

è¿™ä¸ªæƒ³æ³•éžå¸¸ç®€å•:å°†å¯¹è±¡æ£€æµ‹é—®é¢˜**é‡æ–°å®šä¹‰ä¸ºæ–‡æœ¬(ä»¤ç‰Œ)ç”Ÿæˆä»»åŠ¡**ï¼æˆ‘ä»¬å¸Œæœ›æ¨¡åž‹"**å‘Šè¯‰æˆ‘ä»¬**"å›¾åƒä¸­å­˜åœ¨å“ªäº›å¯¹è±¡ï¼Œä»¥åŠå®ƒä»¬çš„è¾¹ç•Œæ¡†(bboxes)çš„(xï¼Œy)åæ ‡ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä»¥ç‰¹å®šçš„æ ¼å¼åœ¨ç”Ÿæˆçš„åºåˆ—ä¸­æ˜¾ç¤ºï¼Œå°±åƒæ–‡æœ¬ç”Ÿæˆä¸€æ ·ï¼

![](img/d5752c1903e773cb4a6520cb2866e90d.png)

pix2seq çš„å·¥ä½œåŽŸç†:å®ƒç”Ÿæˆä¸€ç³»åˆ—æ ‡è®°ï¼Œå‘Šè¯‰æ¯ä¸ªå¯¹è±¡åœ¨å“ªé‡Œ(BOS =å¥é¦–ï¼ŒEOS =å¥å°¾)|ä½œè€…å›¾ç‰‡

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œ**ç‰©ä½“æ£€æµ‹**ä»»åŠ¡è¢«è½¬æ¢æˆç±»ä¼¼**å›¾åƒå­—å¹•**çš„ä»»åŠ¡:åœ¨æ–‡æœ¬(åºåˆ—)ä¸­æè¿°å›¾åƒï¼Œä½†è¿™æ¬¡å‘Šè¯‰æˆ‘ä»¬ç‰©ä½“çš„ç¡®åˆ‡ä½ç½®ã€‚

# Pix2Seq:ç®€å•å®žçŽ°

## æ‰€éœ€æ¨¡å—

ä¸Ž Pix2Seq æœ€æŽ¥è¿‘çš„ä»»åŠ¡æ˜¯å›¾åƒå­—å¹•ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸€ä¸ª**å›¾åƒç¼–ç å™¨**æ¥å°†å›¾åƒè½¬æ¢æˆéšè—è¡¨ç¤ºçš„å‘é‡ï¼Œç„¶åŽéœ€è¦ä¸€ä¸ª**è§£ç å™¨**æ¥èŽ·å–å›¾åƒè¡¨ç¤ºå’Œå…ˆå‰ç”Ÿæˆçš„æ ‡è®°çš„å›¾åƒè¡¨ç¤ºï¼Œå¹¶é¢„æµ‹ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè®°å·åŒ–å™¨æ¥å°†å¯¹è±¡ç±»å’Œåæ ‡è½¬æ¢æˆå½¢æˆå®ƒä»¬çš„ç‰¹æ®Šè¯æ±‡çš„è®°å·ï¼Œå°±åƒè‡ªç„¶è¯­è¨€ä¸­çš„å•è¯ä¸€æ ·ã€‚

## æˆ‘å¯¹ Pix2Seq çš„ç®€å•å®žçŽ°

![](img/dd9894dbdc0a4a4b5739b6de8ae69862.png)

æˆ‘å¯¹ä½œè€…çš„ Pix2Seq | Image çš„ç®€å•å®žçŽ°

ä¸Šå›¾å¯ä»¥çœ‹åˆ°è¿™ä¸ªé¡¹ç›®çš„é«˜å±‚ç®¡é“ã€‚å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå›¾åƒæ•°æ®é›†å’Œå®ƒä»¬çš„æ¡†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [**Pascal VOC 2012 æ•°æ®é›†**](http://host.robots.ox.ac.uk/pascal/VOC/voc2012/) ã€‚æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»Žå¤´å¼€å§‹ç¼–å†™è‡ªå·±çš„**è®°å·èµ‹äºˆå™¨**ï¼Œå°† bbox ç±»å’Œåæ ‡è½¬æ¢æˆä¸€ç³»åˆ—è®°å·ã€‚ç„¶åŽï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ **DeiT** (æ¥è‡ªè¿™ç¯‡[è®ºæ–‡](https://arxiv.org/abs/2012.12877))ä½œä¸ºæˆ‘ä»¬çš„**å›¾åƒç¼–ç å™¨**ï¼Œå¹¶å°†å›¾åƒåµŒå…¥é¦ˆé€åˆ°ä¸€ä¸ªæ™®é€šçš„**å˜åŽ‹å™¨è§£ç å™¨**(æ¥è‡ªè¿™ç¯‡[è®ºæ–‡](https://arxiv.org/abs/1706.03762?context=cs))ã€‚è§£ç å™¨çš„ä»»åŠ¡æ˜¯æ ¹æ®å‰ä¸€ä¸ªæ ‡è®°é¢„æµ‹ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚è§£ç å™¨çš„è¾“å‡ºè¢«æä¾›ç»™è¯­è¨€å»ºæ¨¡æŸå¤±å‡½æ•°ã€‚

æœ¬æ•™ç¨‹çš„ä»£ç å¯åœ¨ä»¥ä¸‹é“¾æŽ¥èŽ·å¾—:
- [**Google Colab ç¬”è®°æœ¬**](https://colab.research.google.com/drive/1UeYIZ6_GHNwCHSi8nNV5dVc3oUrM5-BA?usp=sharing)
-[**ka ggle ç¬”è®°æœ¬**](https://www.kaggle.com/code/moeinshariatnia/object-detection-w-transformers-pix2seq-pytorch/notebook)
- [**æˆ‘çš„ GitHub repo**](https://github.com/moein-shariatnia/Pix2Seq)

## **æ•°æ®é›†**

æ­£å¦‚æˆ‘å‰é¢æåˆ°çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ VOC 2012 æ•°æ®é›†å’Œæ¥è‡ª **20 ç±»**çš„å›¾åƒåŠå…¶ç›¸åº”çš„å¯¹è±¡ã€‚è¯¥è®ºæ–‡ä½¿ç”¨ COCO æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†æ¯” VOC å¤§ä¸€ä¸ªæ•°é‡çº§ï¼Œå¹¶ä¸”ä»–ä»¬è¿˜åœ¨ COCO ä¸Šè®­ç»ƒä¹‹å‰åœ¨æ›´å¤§çš„æ•°æ®é›†ä¸Šé¢„å…ˆè®­ç»ƒæ¨¡åž‹ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘å°†ä½¿ç”¨è¿™ä¸ªç›¸å½“å°çš„ VOC æ•°æ®é›†ã€‚

Pascal VOC 2012 è¯¾ç¨‹

æˆ‘ä»¬éœ€è¦ä¸€ä¸ª PyTorch æ•°æ®é›†ç±»ï¼Œå®ƒä»¥åºåˆ—çš„å½¢å¼ä¸ºæˆ‘ä»¬æä¾›å›¾åƒåŠå…¶ bbox åæ ‡å’Œç±»ã€‚

å¦‚æ‚¨æ‰€è§ï¼Œè¿™é‡Œçš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯æ‚¨æœŸæœ›ä»Žç®€å•çš„åˆ†ç±»æ•°æ®é›†å¾—åˆ°çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å°çš„å·®å¼‚ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ª**è®°å·èµ‹äºˆå™¨**å°†æˆ‘ä»¬çš„æ ‡ç­¾å’Œ bbox åæ ‡(x å’Œ y)è½¬æ¢æˆä¸€ä¸ªåºåˆ—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸ºè¯­è¨€å»ºæ¨¡ä»»åŠ¡æ‰§è¡Œè®­ç»ƒæˆ‘ä»¬çš„æ¨¡åž‹(æ ¹æ®ä¹‹å‰çœ‹åˆ°çš„è®°å·é¢„æµ‹ä¸‹ä¸€ä¸ªè®°å·)ã€‚

## æ ‡è®°å™¨

æˆ‘ä»¬å¦‚ä½•å°†è¿™äº›ä¿¡æ¯è½¬æ¢æˆä¸€ä¸ªåºåˆ—ï¼Ÿå—¯ï¼Œæ²¡é‚£ä¹ˆéš¾ã€‚ä¸ºäº†è¡¨ç¤ºå›¾åƒä¸­çš„å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦ 5 ä¸ªæ•°å­—:4 ä¸ªåæ ‡æ•°å­—å’Œ 1 ä¸ªæ•°å­—æ¥è¡¨ç¤ºå®ƒå±žäºŽå“ªä¸ªç±»ã€‚

ä½ å®žé™…ä¸Šéœ€è¦çŸ¥é“ä¸€ä¸ªè¾¹ç•Œæ¡†çš„ 2 ä¸ªç‚¹çš„åæ ‡ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨å›¾åƒä¸­ç”»å‡ºå®ƒï¼›åœ¨ **pascal æ ¼å¼**ä¸­ï¼Œæˆ‘ä»¬ç”¨ bbox çš„**å·¦ä¸Šç‚¹**å’Œ**å³ä¸‹ç‚¹**ä½œä¸ºé‚£ä¸¤ä¸ªä¸´ç•Œç‚¹ï¼Œæ¯ä¸ªç‚¹ç”¨å®ƒçš„ x å’Œ y å€¼æ¥è¡¨ç¤ºâ†’æ‰€ä»¥ï¼Œæˆ‘ä»¬æ€»å…±éœ€è¦ 4 ä¸ªæ•°æ¥ç”»ä¸€ä¸ªåŒ…å›´ç›’ã€‚ä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ›¿ä»£æ ¼å¼æ¥è¡¨ç¤ºä¸€ä¸ªè¾¹ç•Œæ¡†ã€‚å¦å¤–ï¼Œçœ‹çœ‹ x å’Œ y è½´çš„èµ·ç‚¹åœ¨å“ªé‡Œ(0ï¼Œ0 ç‚¹)ã€‚

![](img/26f100c1700af3f6d5c83236022063f9.png)

ç”¨ä¸åŒçš„æ ¼å¼æ¥è¡¨ç¤ºè¾¹ç•Œæ¡†åŠå…¶åæ ‡|æ¥è‡ª[ç›¸å†Œæ–‡æ¡£](https://albumentations.ai/docs/getting_started/bounding_boxes_augmentation/)çš„å›¾åƒ

æ­£å¦‚æ‚¨åœ¨æ•°æ®é›†çš„ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°† bbox åæ ‡å’Œæ ‡ç­¾äº¤ç»™æˆ‘ä»¬çš„æ ‡è®°å™¨ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªç®€å•çš„æ ‡è®°åˆ—è¡¨ã€‚åˆ†è¯å™¨éœ€è¦å®Œæˆä»¥ä¸‹ä»»åŠ¡:

1.  **æ ‡è®° w/e ç‰¹æ®Šä»¤ç‰Œ(BOS å’Œ EOS ä»¤ç‰Œ)åºåˆ—çš„å¼€å§‹å’Œç»“æŸ**ã€‚
2.  **é‡åŒ–**åæ ‡çš„è¿žç»­å€¼(æˆ‘ä»¬å¯ä»¥å°† x=34.7 ä½œä¸ºä¸€ä¸ªç‚¹çš„åæ ‡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åƒ 34 è¿™æ ·çš„ç¦»æ•£å€¼ä½œä¸ºæˆ‘ä»¬çš„è®°å·ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆæ˜¯åœ¨ä¸€ç»„æœ‰é™çš„è®°å·ä¸Šè¿›è¡Œåˆ†ç±»)
3.  **å°†å¯¹è±¡çš„æ ‡ç­¾**ç¼–ç æˆç›¸åº”çš„ä»¤ç‰Œ
4.  **åœ¨æœ€ç»ˆåºåˆ—ä¸­éšæœºåŒ–å¯¹è±¡çš„é¡ºåº**(æ›´å¤šä¿¡æ¯è§ä¸‹æ–‡)

å¦‚æžœä½ ç†Ÿæ‚‰ NLP åº”ç”¨ç¨‹åºï¼Œè¿™äº›æ­¥éª¤å¯èƒ½å¬èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤„ç†è‡ªç„¶è¯­è¨€ä¸­çš„å•è¯æ—¶ä¹Ÿä¼šç”¨åˆ°å®ƒä»¬ï¼›æˆ‘ä»¬éœ€è¦å¯¹å®ƒä»¬è¿›è¡Œæ ‡è®°ï¼Œå¹¶å°†æ¯ä¸ªå•è¯åˆ†é…ç»™å®ƒè‡ªå·±çš„ç¦»æ•£æ ‡è®°ï¼Œæ ‡è®°åºåˆ—çš„å¼€å§‹å’Œç»“æŸï¼Œç­‰ç­‰ã€‚

å…³äºŽè¿™ä¸ªåˆ—è¡¨ä¸­çš„æ•°å­— 4ï¼Œè¿™å°±æ˜¯è¿™ç¯‡è®ºæ–‡æ‰€åšçš„ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå…³äºŽå®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå¥½ä¸»æ„çš„å¹¿æ³›çš„æ¶ˆèžç ”ç©¶ã€‚å®ƒè¯´çš„æ˜¯ï¼Œæ¯æ¬¡æˆ‘ä»¬å‘æ¨¡åž‹æ˜¾ç¤ºç›¸åŒçš„å›¾åƒ(åœ¨ä¸åŒçš„æ—¶æœŸ)ï¼Œæˆ‘ä»¬éšæœºåŒ–å¯¹è±¡åœ¨ç›¸åº”åºåˆ—ä¸­å‡ºçŽ°çš„é¡ºåºï¼Œæˆ‘ä»¬å°†è¯¥åºåˆ—æä¾›ç»™æ¨¡åž‹(å…¶ä¸­ä¸€ä¸ªä»¤ç‰Œè¢«ç§»ä½)å’Œæˆ‘ä»¬çš„æŸå¤±å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœå›¾åƒä¸­æœ‰â€œäººâ€ã€â€œè½¦â€å’Œâ€œçŒ«â€ï¼Œè®°å·èµ‹äºˆå™¨å’Œæ•°æ®é›†ä¼šå°†è¿™äº›å¯¹è±¡æŒ‰éšæœºé¡ºåºæ”¾å…¥åºåˆ—ä¸­:

*   BOSï¼Œcar_xminï¼Œcar_yminï¼Œcar_xmaxï¼Œcar_ymaxï¼Œcar_labelï¼Œperson_xminï¼Œperson_yminï¼Œperson_xmaxï¼Œperson_ymaxï¼Œperson_labelï¼Œcat_xminï¼Œcat_yminï¼Œcat_xmaxï¼Œcat_ymaxï¼Œcat_labelï¼ŒEOS
*   BOSï¼Œperson_xminï¼Œperson_yminï¼Œperson_xmaxï¼Œperson_ymaxï¼Œperson_labelï¼Œcar_xminï¼Œcar_yminï¼Œcar_xmaxï¼Œcar_ymaxï¼Œcar_labelï¼Œcat_xminï¼Œcat_yminï¼Œcat_xmaxï¼Œcat_ymaxï¼Œcat_labelï¼ŒEOS
*   â€¦

å…³äºŽåæ ‡è¿žç»­å€¼å¦‚ä½•é‡åŒ–çš„å¦ä¸€ä¸ªæ³¨æ„äº‹é¡¹:å‡è®¾**å›¾åƒå¤§å°ä¸º 224** ã€‚è¿™ 4 ä¸ªåæ ‡(12.2ï¼Œ35.8ï¼Œ68.1ï¼Œ120.5)å¯ä»¥æœ‰ä¸€ä¸ª bboxã€‚

ä½ å°†éœ€è¦è‡³å°‘ **224 ä¸ªä»¤ç‰Œ** (num_bins)æ‰èƒ½ä»¥ 1 ä¸ªåƒç´ çš„ç²¾åº¦ä»¤ç‰ŒåŒ–(é‡åŒ–)è¿™ 4 ä¸ªæ•°å­—(ä½ å°†ä¸¢å¤± 1 ä¸ªåƒç´ ä»¥ä¸‹çš„ä¿¡æ¯)ã€‚æ­£å¦‚æ‚¨åœ¨æ ‡è®°å™¨ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œè¦å°†è¿™äº› bbox åæ ‡è½¬æ¢æˆå®ƒä»¬çš„æ ‡è®°åŒ–ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

1.  æ ‡å‡†åŒ–åæ ‡(é€šè¿‡å°†å®ƒä»¬é™¤ä»¥æœ€å¤§å€¼= 224ï¼Œä½¿å®ƒä»¬åœ¨ 0 å’Œ 1 ä¹‹é—´)
2.  è¿™æ ·åš: *int(x * (num_bins-1))*

æ‰€ä»¥ï¼Œè½¬æ¢åŽçš„ç‰ˆæœ¬å°†æ˜¯:(12ï¼Œ35ï¼Œ67ï¼Œ119)ã€‚è¯·è®°ä½ï¼ŒPython **ä¸­çš„ int()å‡½æ•°ä¸ä¼šå°†æ•°å­—å››èˆäº”å…¥åˆ°æœ€æŽ¥è¿‘çš„æ•´æ•°**ï¼Œè€Œæ˜¯åªä¿ç•™æ•°å­—çš„æ•´æ•°éƒ¨åˆ†ã€‚å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬ä¸¢å¤±äº†ä¸€äº›å…³äºŽ bbox ç¡®åˆ‡ä½ç½®çš„ä¿¡æ¯ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ªéžå¸¸å¥½çš„è¿‘ä¼¼å€¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´å¤§æ•°é‡çš„æ ‡è®°(å¦‚è®ºæ–‡ä¸­æ‰€è¿°çš„ç®±æ•°)ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†å…·æœ‰æ›´ç²¾ç¡®çš„ä½ç½®ã€‚æˆ‘ä»¬çš„æ ‡è®°å™¨ä¹Ÿæœ‰ decode()å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒå°†åºåˆ—è½¬æ¢æˆ bbox åæ ‡å’Œæ ‡ç­¾ã€‚

## æ ¡å¯¹åŠŸèƒ½

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å®žçŽ°ä¸€ä¸ªè‡ªå®šä¹‰çš„ collate_function æ¥æä¾›ç»™æˆ‘ä»¬çš„ PyTorch æ•°æ®åŠ è½½å™¨ã€‚è¿™ä¸ªå‡½æ•°å°†ä¸ºæˆ‘ä»¬å¤„ç†å¡«å……:é€šè¿‡å°† PAD_IDX æ·»åŠ åˆ°è¾ƒçŸ­çš„åºåˆ—ä¸­ï¼Œä½¿æ‰€æœ‰çš„åºåˆ—é•¿åº¦ç›¸åŒï¼Œä»¥ä¾¿èƒ½å¤Ÿç”¨å®ƒä»¬æž„å»ºä¸€ä¸ªæ‰¹å¤„ç†ã€‚æˆ‘ä»¬å°†å¡«å……åºåˆ—åˆ° 300 ä¸ªä»¤ç‰Œçš„å›ºå®šæœ€å¤§é•¿åº¦ã€‚

## ç¼–ç å™¨

æˆ‘ç»ˆäºŽåˆ°äº†å¯¹æ¯ä¸ªæ·±åº¦å­¦ä¹ çˆ±å¥½è€…æ¥è¯´æœ€é…·çš„éƒ¨åˆ†:**æ¨¡åž‹ðŸ˜**

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœ¬æ•™ç¨‹çš„[ç¬¬ä¸€å¼ å›¾ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¼–ç å™¨æ¥èŽ·å–è¾“å…¥å›¾åƒï¼Œå¹¶ç»™æˆ‘ä»¬ä¸€äº›åµŒå…¥(è¡¨ç¤º)ã€‚è®ºæ–‡ç”¨çš„æ˜¯ ResNet50(å…¶ä»–å®žéªŒä¹Ÿç”¨ ViT)ï¼Œä½†æˆ‘å†³å®šç”¨](https://drive.google.com/file/d/19zuuskVKj4GM_9uGcA8a-FBPr1ykuiK6/view?usp=sharing) [**DeiT**](https://arxiv.org/abs/2012.12877) ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®é«˜æ•ˆçš„è§†è§‰è½¬æ¢å™¨ï¼Œæˆ‘è®¤ä¸ºå®ƒéžå¸¸é€‚åˆæˆ‘ä»¬çš„å°æ•°æ®é›†ã€‚åƒ ViT ä¸€æ ·ï¼Œå®ƒå°†å›¾åƒåˆ†å‰²æˆå°å—ï¼Œå¹¶åƒå¤„ç†å¥å­ä¸­çš„å•è¯ä¸€æ ·å¤„ç†å®ƒä»¬ï¼Œè¿™å¯¹äºŽæˆ‘ä»¬çš„ä»»åŠ¡æ¥è¯´ä¹Ÿæ˜¯å¾ˆå¥½çš„ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªå°å—è¿›è¡Œå•ç‹¬çš„åµŒå…¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸‹ä¸€éƒ¨åˆ†å°†å®ƒä»¬äº¤ç»™æˆ‘ä»¬çš„è§£ç å™¨æ¥é¢„æµ‹ç›®æ ‡åºåˆ—(å‚è§ä»Žè‹±è¯­åˆ°æ³•è¯­çš„**ç¿»è¯‘**ï¼Œå…¶ä¸­æˆ‘ä»¬çš„å›¾åƒå°±åƒè‹±è¯­ä¸­çš„ä¸€ä¸ªå¥å­ï¼Œè€ŒåŒ…å« bboxes çš„åæ ‡å’Œæ ‡ç­¾çš„ç›®æ ‡åºåˆ—å°±åƒæ³•è¯­ä¸­çš„å¯¹åº”å¥å­)ã€‚

æˆ‘å°†ä½¿ç”¨ timm åº“æ¥å®žçŽ°ä¸€ä¸ªé¢„å…ˆè®­ç»ƒå¥½çš„ DeiT æ¨¡åž‹ã€‚

ç“¶é¢ˆå±‚æ˜¯å°†è¿™äº›åµŒå…¥çš„ç‰¹å¾æ•°é‡å‡å°‘åˆ°è§£ç å™¨çš„ç‰¹å¾æ•°é‡ã€‚æœ¬æ–‡ä½¿ç”¨äº† 256 çš„è§£ç å™¨ dimï¼Œè¿™å°±æ˜¯æˆ‘åœ¨è¿™é‡Œä½¿ç”¨**å¹³å‡æ± **å‡å°‘å®ƒçš„åŽŸå› ã€‚æ­¤å¤–ï¼Œè¿™ä¸ªæ¨¡åž‹ä¸­çš„ç¬¬ä¸€ä¸ªä»¤ç‰Œä¸Ž CLS ä»¤ç‰Œç›¸å…³ï¼Œæˆ‘å°†åœ¨ forward æ–¹æ³•ä¸­è·³è¿‡å®ƒ(features[:ï¼Œ1:])ã€‚

## è§£ç å™¨

æˆ‘ä»¬çš„è§£ç å™¨é‡‡ç”¨è¾“å…¥å›¾åƒçš„è¡¥ä¸åµŒå…¥ï¼Œå¹¶å­¦ä¹ é¢„æµ‹åŒ…å« bboxes çš„åºåˆ—ã€‚è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ PyTorch **nnã€‚TransformerDecoder** æ¨¡å—å®žçŽ°ä¸€ä¸ªç‰¹å¾å°ºå¯¸ä¸º 256 çš„ 6 å±‚è§£ç å™¨ã€‚æˆ‘ä»¬è¿˜éœ€è¦å‘åµŒå…¥ä¸­æ·»åŠ ä½ç½®åµŒå…¥ï¼Œä»¥ä¾¿æ¨¡åž‹çŸ¥é“æ¯ä¸ªæ ‡è®°åœ¨åºåˆ—ä¸­çš„ä½ç½®(æˆ‘ä¸ºç¼–ç å™¨æ ‡è®°å’Œè§£ç å™¨æ ‡è®°éƒ½æ·»åŠ äº†ä½ç½®åµŒå…¥ã€‚è™½ç„¶æˆ‘ä»¬å¿…é¡»ä¸ºè§£ç å™¨è¿™æ ·åšï¼Œä½†æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦å°†å®ƒä»¬æ·»åŠ åˆ°ç¼–ç å™¨æ ‡è®°ä¸­ï¼Œå› ä¸º DeiT æ¨¡åž‹çŸ¥é“è¡¥ä¸æœ¬èº«çš„é¡ºåº)ã€‚æˆ‘å°±æ˜¯é é‚£äº› **nn åšåˆ°çš„ã€‚å‚æ•°**æ¨¡å—å°†åœ¨æ¯ä¸ªæ ‡è®°ä½ç½®å­¦ä¹  1 ä¸ªå‚æ•°ã€‚æœ€åŽï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª **nnã€‚çº¿æ€§**å±‚æ¥é¢„æµ‹æˆ‘ä»¬è¯æ±‡è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚

**create_mask** å‡½æ•°ä¸ºæˆ‘ä»¬æä¾›äº†è®­ç»ƒè§£ç å™¨æ‰€éœ€çš„ä¸¤ä¸ªæŽ©ç :ä¸€ä¸ªå‘Šè¯‰æ¨¡åž‹å¿½ç•¥å¡«å……ä»¤ç‰Œå¹¶ä¸”ä¸å°†å®ƒä»¬åˆå¹¶åˆ°å®ƒçš„æ³¨æ„æ¨¡å—ä¸­ï¼Œå¦ä¸€ä¸ªå±è”½æœªæ¥çš„ä»¤ç‰Œï¼Œä»¥ä¾¿ä½¿è§£ç å™¨ä»…é€šè¿‡æŸ¥çœ‹å½“å‰ä»¤ç‰Œå’Œå…ˆå‰ä»¤ç‰Œæ¥é¢„æµ‹ä»¤ç‰Œã€‚

## æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·

è¿™æ˜¯ä¸€ä¸ªå°è£…äº†ç¼–ç å™¨å’Œè§£ç å™¨çš„ç®€å•ç±»ã€‚å®ƒè¿˜æœ‰ä¸€ä¸ª**é¢„æµ‹**å‡½æ•°ï¼Œè°ƒç”¨è§£ç å™¨çš„é¢„æµ‹å‡½æ•°(ä¸Šé¢æ²¡æœ‰æ˜¾ç¤ºï¼Œæˆ‘ä»¬ç¨åŽä¼šçœ‹åˆ°)æ¥æ£€æµ‹å›¾åƒä¸­çš„å¯¹è±¡ã€‚

## åŸ¹å…»

çŽ°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è®­ç»ƒè¿™ä¸ªæ¨¡åž‹ã€‚ä¸‹é¢çš„å¤§éƒ¨åˆ†ä»£ç åªæ˜¯æ ‡å‡†çš„ PyTorch åŸ¹è®­æ ·æ¿ï¼Œä½†å…¶ä¸­æœ‰ä¸€ç‚¹å¾ˆç®€å•ä½†å¾ˆé‡è¦ã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬åƒè®­ç»ƒè¯­è¨€æ¨¡åž‹ä¸€æ ·è®­ç»ƒæ¨¡åž‹(ä¾‹å¦‚ GPT)ï¼Œå®ƒæ˜¯è¿™æ ·å·¥ä½œçš„â†’æ¨¡åž‹åªéœ€è¦é€šè¿‡çœ‹åˆ°å‰é¢çš„æ ‡è®°(å·¦è¾¹çš„æ ‡è®°)æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚å¼€å§‹æ—¶ï¼Œå®ƒåªçœ‹åˆ° BOS è¯­å¥ï¼Œå®ƒéœ€è¦é¢„æµ‹ä¸‹ä¸€ä¸ªæ ‡è®°ï¼Œä»¥æ­¤ç±»æŽ¨ã€‚è¿™å¯ä»¥é€šè¿‡è¿™éƒ¨åˆ†æ¥å®žçŽ°:

*   y_input = y[:ï¼Œ:-1]
*   y_expected = y[:ï¼Œ1:]
*   preds =æ¨¡åž‹(xï¼Œy _ è¾“å…¥)

æˆ‘åœ¨ Kaggle ä¸Šä½¿ç”¨å•ä¸ª GPU è®­ç»ƒäº†è¿™ä¸ªæ¨¡åž‹ï¼Œä»…åœ¨ 6 å°æ—¶å†…è¿›è¡Œäº† 25 æ¬¡ã€‚è¿™å¹¶ä¸å¤šï¼Œä½†è¶³ä»¥åœ¨è¯„ä¼°æŒ‡æ ‡ä¸ŠèŽ·å¾—ä¸é”™çš„è¡¨çŽ°ã€‚

![](img/d0265a39e6f1d85093eadce3e1811257.png)

:)

ç‰©ä½“æ£€æµ‹æœ€å¸¸è§çš„åº¦é‡æ˜¯**å¹³å‡ç²¾åº¦(AP)** ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºŽå®ƒçš„[ã€‚ç»è¿‡å‡ ä¸ªå°æ—¶çš„å¤§é‡æ•°æ®è®­ç»ƒï¼Œæœ¬æ–‡å¾—åˆ°äº†ä¸€ä¸ª 43 w/ ResNet50 éª¨å¹²ç½‘çš„ APã€‚ç”¨è¿™ä¸ªå°æ¨¡åž‹å’ŒçŸ­è®­ç»ƒæ—¶é—´ï¼Œæˆ‘å¯ä»¥åœ¨æˆ‘çš„éªŒè¯é›†ä¸Šå¾—åˆ° 26.4 çš„ APï¼Œè¿™å¾ˆé…·ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¦‚ä½•è½»æ¾å®žçŽ°æœ¬æ–‡çš„æ•™ç¨‹ï¼Œæˆ‘çš„ç›®æ ‡ä¸æ˜¯ç”¨è¿™ä¸ªæ‰“è´¥ SOTAï¼](https://jonathan-hui.medium.com/map-mean-average-precision-for-object-detection-45c121a31173)

![](img/ca70981b64ee1620e9f07fe8a566c631.png)

æˆ‘çš„æ¨¡åž‹åœ¨ Pascal VOC æ•°æ®é›†ä¸Šçš„å¹³å‡ç²¾åº¦è¡¨çŽ°|å›¾ç‰‡ç”±ä½œè€…æä¾›

## æŽ¨ç†

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ¨¡åž‹ä¸ºæµ‹è¯•å›¾åƒç”Ÿæˆæ£€æµ‹åºåˆ—ã€‚è¿™æ˜¯è§£ç å™¨ç±»çš„é¢„æµ‹æ–¹æ³•ã€‚å®ƒèŽ·å–å…ˆå‰ç”Ÿæˆçš„æ ‡è®°ï¼Œå°†å®ƒä»¬å¡«å……åˆ° max_lengthï¼Œå¹¶é¢„æµ‹æ‰¹ä¸­æ¯ä¸ªåºåˆ—çš„ä¸‹ä¸€ä¸ªæ ‡è®°ï¼Œç„¶åŽè¿”å›žè¿™äº›æ–°æ ‡è®°ã€‚

ä¸‹é¢çš„ **generate()** å‡½æ•°æ˜¾ç¤ºäº†æ•´ä¸ªåºåˆ—ç”Ÿæˆç®¡é“çš„ç®€åŒ–ç‰ˆæœ¬â†’é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ shape (batch_sizeï¼Œ1)åˆ›å»ºä¸€ä¸ªæ‰¹å¤„ç†ï¼Œè¯¥æ‰¹å¤„ç†åªåŒ…å«æ‰¹å¤„ç†ä¸­æ¯ä¸ªå›¾åƒçš„ BOS æ ‡è®°ã€‚è¯¥æ¨¡åž‹èŽ·å–å›¾åƒå’Œè¿™äº› BOS æ ‡è®°ï¼Œç„¶åŽé¢„æµ‹æ¯ä¸ªå›¾åƒçš„ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚æˆ‘ä»¬èŽ·å–æ¨¡åž‹çš„é¢„æµ‹ï¼Œå¯¹å…¶æ‰§è¡Œ softmax å’Œ argmax ä»¥èŽ·å¾—é¢„æµ‹çš„æ ‡è®°ï¼Œå¹¶å°†è¿™ä¸ªæ–°é¢„æµ‹çš„æ ‡è®°ä¸Žä¹‹å‰çš„ batch_preds å¼ é‡è¿žæŽ¥ï¼Œè¯¥å¼ é‡å…·æœ‰ BOS æ ‡è®°ã€‚ç„¶åŽæˆ‘ä»¬é‡å¤è¿™ä¸ªå¾ªçŽ¯ max_len æ¬¡ã€‚

æœ€åŽï¼Œæˆ‘ä»¬é€šè¿‡æ ‡è®°å™¨çš„ decode()æ–¹æ³•å¯¹é¢„æµ‹çš„æ ‡è®°è¿›è¡Œè§£ç ã€‚ä½ å¯ä»¥çœ‹çœ‹æˆ‘çš„ GitHubã€[Colab ç¬”è®°æœ¬](https://colab.research.google.com/drive/1UeYIZ6_GHNwCHSi8nNV5dVc3oUrM5-BA?usp=sharing)æˆ–è€… [Kaggle ç¬”è®°æœ¬](https://www.kaggle.com/code/moeinshariatnia/object-detection-w-transformers-pix2seq-pytorch/notebook)ä¸Šçš„å…·ä½“å®žçŽ°ã€‚

## ç»“æžœ

æœ€åŽï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æ¨¡åž‹åˆ°ç›®å‰ä¸ºæ­¢çš„ä¸€äº›ç»“æžœã€‚æ¨¡åž‹å¹¶ä¸æ€»æ˜¯è¿™ä¹ˆå¥½(è¿™äº›éƒ½æ˜¯ç²¾å¿ƒæŒ‘é€‰çš„ï¼)ï¼Œä½†è¿™äº›ç»“æžœè¡¨æ˜Žï¼Œå®žçŽ°å·²ç»è¶³å¤Ÿå¥½äº†ï¼Œå¦‚æžœæœ‰æ›´å¤§çš„æ•°æ®é›†å’Œæ¨¡åž‹ä»¥åŠæ›´é•¿çš„è®­ç»ƒæ—¶é—´ï¼Œæ‚¨å¯ä»¥å¾ˆå®¹æ˜“åœ°èŽ·å¾—è®ºæ–‡ä¸­æåˆ°çš„é‚£äº›å®Œç¾Žçš„ç»“æžœã€‚

![](img/d48378b8b5bd04b49b54b4cdd4ae45e2.png)

æˆ‘ä»¬çš„æœ€ç»ˆæ¨¡åž‹åœ¨éªŒè¯é›†ä¸Šçš„é¢„æµ‹|ä½œè€…å›¾ç‰‡

å½“å›¾åƒä¸­æœ‰ 1 åˆ° 2 ä¸ª bboxes æ—¶ï¼Œæˆ‘ä»¬çš„æ¨¡åž‹å·¥ä½œå¾—æœ€å¥½ï¼Œå½“å›¾åƒä¸­æœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå®ƒçš„æ€§èƒ½ä¼šä¸‹é™ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†æˆ‘ä»¬æ¨¡åž‹çš„ä¸€äº›å¤±è´¥æ¡ˆä¾‹:

![](img/d6f17db769b26ca4883a5a78a08dd78b.png)

æˆ‘ä»¬æ¨¡åž‹çš„ä¸€äº›å¤±è´¥æ¡ˆä¾‹|ä½œè€…å›¾ç‰‡

## æœ€åŽçš„è¯

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªæ•™ç¨‹ï¼Œå¹¶å­¦åˆ°äº†ä¸€äº›æ–°çš„ä¸œè¥¿ã€‚ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘å°†å¾ˆé«˜å…´å¬åˆ°ä½ å¯¹æœ¬æ•™ç¨‹çš„è¯„è®ºï¼Œæˆ–è€…å›žç­”ä½ å¯¹è®ºæ–‡å’Œæ¨¡åž‹çš„ä»»ä½•é—®é¢˜ã€‚

ç¥æ‚¨æ„‰å¿«ï¼

æˆ‘æŠŠæˆ‘æ‰€æœ‰çš„ä»£ç éƒ½ä½œä¸º [**Google Colab ç¬”è®°æœ¬**](https://colab.research.google.com/drive/1UeYIZ6_GHNwCHSi8nNV5dVc3oUrM5-BA?usp=sharing) å’Œä¸€ä¸ª [**Kaggle ç¬”è®°æœ¬**](https://www.kaggle.com/code/moeinshariatnia/object-detection-w-transformers-pix2seq-pytorch/notebook) æä¾›ã€‚æˆ‘è¿˜æŠŠæ•´ä¸ªé¡¹ç›®å’Œä»£ç  [**æ”¾åˆ°äº†æˆ‘çš„ GitHub**](https://github.com/moein-shariatnia/Pix2Seq) ä¸Šã€‚

> ***å…³äºŽæˆ‘***
> 
> æˆ‘æ˜¯ Moein Shariatniaï¼Œä¸€ååŒ»ç§‘å­¦ç”Ÿï¼Œæœºå™¨å­¦ä¹ å¼€å‘äººå‘˜å’Œç ”ç©¶å‘˜ã€‚åœ¨æˆ‘çš„ç ”ç©¶ä¸­ï¼Œæˆ‘å¯¹æ·±åº¦å­¦ä¹ æ¨¡åž‹çš„æ³›åŒ–å’Œè¿ç§»å­¦ä¹ æ€§èƒ½æ„Ÿå…´è¶£ã€‚æˆ‘ä¹Ÿå–œæ¬¢å®žçŽ°æœ€å…ˆè¿›çš„æ·±åº¦æ¨¡åž‹ï¼Œå¹¶ç†è§£å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
> 
> ***æˆ‘çš„è°·æ­Œå­¦æœ¯***:[*https://scholar.google.com/citations?user=YLHsTOUAAAAJ&HL = en*](https://scholar.google.com/citations?user=YLHsTOUAAAAJ&hl=en)
> *æˆ‘çš„ GitHub*:[*https://github.com/moein-shariatnia*](https://github.com/moein-shariatnia)